# Vendor

299ko

# Product

299ko

# version

  V2.0.0

# Download 

https://github.com/299Ko/299ko/

# Vulnerability

Delete any file

# Description

The root of the vulnerability lies within the `getSentDir()` and `delete()` method in the `plugin/filemanager/controllers/FileManagerAPIController.php` file,users can delete any file on the server.

# Analysis

1. Flawed Path Filtering Logic in the `getSentDir()` Function

The root of the vulnerability lies within the `getSentDir()` method in the `plugin/filemanager/controllers/FileManagerAPIController.php` file. This method is responsible for processing user-supplied directory paths, but its security filtering mechanism is severely flawed.

- Filtering Logic: The code attempts to prevent directory traversal by checking if the *last part* of the path is `..`:

<img width="556" height="137" alt="image" src="https://github.com/user-attachments/assets/2f5f648e-d799-4057-82d2-7082c8a717ea" />

- The Flaw: This check is ineffective. When an attacker provides an input like `../../../../common`, the path is split into the array `['..', '..', '..', '..', 'common']`. The code only inspects the last element, `'common'`, causing the security check to be completely bypassed. All the `..` sequences are preserved.

- The Result: The function proceeds to concatenate this unfiltered, malicious path with the base upload directory (`data/upload/files/`), constructing an illegal path that points to an arbitrary folder within the application's root, such as the `common` directory.

2. Blind Trust in Unsafe Input by the `delete()` Function

<img width="787" height="319" alt="image" src="https://github.com/user-attachments/assets/a5a1aaf4-5e0e-4bb9-a2f0-ef096b2d4d3b" />


The `delete()` method is where the vulnerability is triggered. It makes the following mistakes when performing the deletion operation:

- Calling an Untrusted Function: It first calls the flawed `getSentDir()` method, obtaining a directory path that has been manipulated by the attacker.
- Lack of Secondary Validation: It completely trusts the path returned by `getSentDir()` without performing any additional security checks (e.g., using `realpath()` to verify that the path is within the allowed directory).
- Direct Use of User Input: It directly takes the filename from `$_POST['filename']` and immediately executes the deletion operation on the manipulated path.

Attack Flow Summary

An attacker sends a specially crafted POST request, controlling both the `fmFolderToSee` and `filename` parameters:

1. The value of `fmFolderToSee` (e.g., `../../../../common`) exploits the flaw in `getSentDir()` to "traverse" the operating directory to a critical application directory.
2. The value of `filename` (e.g., `config.php`) specifies the target file to be deleted within that critical directory.
3. The `delete()` method blindly executes these instructions, ultimately leading to the severe consequence of arbitrary file deletion.

Recurrence of vulnerabilitiesï¼š

<img width="1449" height="786" alt="image" src="https://github.com/user-attachments/assets/a1958ac7-17f4-4b63-8fdd-e12214ddacdb" />

Successfully deleted the test file:

<img width="1438" height="784" alt="image" src="https://github.com/user-attachments/assets/2cee09df-8acc-4173-b698-1e818a7327c7" />

# POC
```
POST /299ko/admin/filemanager/view-ajax/delete/448c021d26939c56c9cf21b20fd8a78a663e56bf HTTP/1.1
Host: localhost
Content-Length: 265
Cookie: PHPSESSID=34f19r1adef17bu1vlm6o7u2ls; koAutoConnect=by111%40126.com%2F%2F5a8fc33afe42d3f03d0dbbd7a2661336e208bfc2
Connection: keep-alive

------WebKitFormBoundaryKNUgFjaLIzzLKnne
Content-Disposition: form-data; name="filename"

1.txt
------WebKitFormBoundaryKNUgFjaLIzzLKnne
Content-Disposition: form-data; name="fmFolderToSee"

../../../../../../../
------WebKitFormBoundaryKNUgFjaLIzzLKnne--



```
